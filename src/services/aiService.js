// src/services/aiService.js// ======================================================// üéØ Servizio centrale AI ‚Äì OpenAI / Groq// Una sola funzione: callAI (pi√π alias callAIModel)// ======================================================import OpenAI from "openai";import Groq from "groq-sdk";import dotenv from "dotenv";dotenv.config();const aiProvider = process.env.AI_PROVIDER || "openai";const openai = new OpenAI({  apiKey: process.env.OPENAI_API_KEY,});const groq = new Groq({  apiKey: process.env.GROQ_API_KEY,});/** * ‚úÖ FUNZIONE UNICA PER TUTTE LE CHIAMATE AI * - prompt: string * - options: { model?, temperature?, max_tokens? } oppure string (retrocompatibilit√†) * - ritorna SEMPRE JSON.parse(content) se possibile */export async function callAI(prompt, options = {}) {  // Retrocompatibilit√† nel caso venga passato una stringa come secondo argomento (tipo "script")  if (typeof options === "string") {    options = {};  }  const model = options.model || "gpt-4o-mini";  const temperature = options.temperature ?? 0.7;  const max_tokens = options.max_tokens || 4000;  try {    let content;    if (aiProvider === "groq") {      const response = await groq.chat.completions.create({        model,        messages: [{ role: "user", content: prompt }],        temperature,        max_tokens,      });      content = response.choices[0]?.message?.content || "";    } else {      const response = await openai.chat.completions.create({        model,        messages: [{ role: "user", content: prompt }],        temperature,        max_tokens,      });      content = response.choices[0]?.message?.content || "";    }    // Prova a fare JSON.parse ‚Äì se fallisce, ritorna un oggetto di errore    try {      // Pulizia base: se il modello mette ```json ... ```      const first = content.indexOf("{");      const last = content.lastIndexOf("}");      if (first !== -1 && last !== -1) {        const sliced = content.substring(first, last + 1);        return JSON.parse(sliced);      }      return JSON.parse(content);    } catch (parseErr) {      console.error("‚ùå JSON PARSE ERROR (callAI):", parseErr, "\nRAW:", content);      return { error: "Invalid JSON from AI", raw: content };    }  } catch (error) {    console.error("‚ùå AI Service Error:", error);    return { error: true, message: error.message };  }}// üîÅ Alias retrocompatibile per vecchio codiceexport const callAIModel = callAI;