import express from "express";import { callAI } from "../services/aiService.js";import {  getDefaultProfile,  getProfileByHandle} from "../services/profileManager.js";const router = express.Router();/** * Ultra Script Generator — versione più avanzata * per contenuti Over50/60/70 — Zen YouTube Coach Pro */router.post("/generateScriptUltra", async (req, res) => {  try {    const {      idea,      outline,      keywords,      voice,      audience,      handle    } = req.body || {};    if (!idea && !outline) {      return res.status(400).json({        error: "Provide at least 'idea' or 'outline'"      });    }    // 1️⃣ Carica il profilo corretto    const profile = handle      ? getProfileByHandle(handle)      : getDefaultProfile();    // 2️⃣ Prompt ultra avanzato — struttura narrativa premium    const prompt = `Sei Zen YouTube Coach Pro — versione ULTRA.Pubblico: ${profile.targetAudience.join(", ")}Canale: ${profile.channelName}Crea SOLO JSON valido:{ "title": "", "hook": "", "script_full": "", "sections": [   { "id":1, "title":"", "text":"" } ]}Regole:- Stile narrativo emozionale + PNL- Ritmo rapido, micro-storie continue- Agganci interni ogni 20–30 secondi- Molto orientato ai problemi Over50/60/70- Linguaggio semplice ma empatico- Zero termini tecnici inutiliIdea:"${idea || ""}"Outline:"${outline || ""}"Keywords:"${keywords || ""}"Voce desiderata:"${voice || "calma, rassicurante"}"`;    const aiRaw = await callAI(prompt, {      model: "gpt-4o-mini",      temperature: 0.85,      max_tokens: 5000    });    let aiResponse;    try {      aiResponse = typeof aiRaw === "string" ? JSON.parse(aiRaw) : aiRaw;    } catch (e) {      return res.status(500).json({        error: "AI returned invalid JSON",        raw: aiRaw      });    }    return res.json({      success: true,      profile,      result: aiResponse    });  } catch (err) {    console.error("generateScriptUltra ERROR:", err);    return res.status(500).json({      error: "generateScriptUltra crashed",      details: err.message    });  }});export default router;