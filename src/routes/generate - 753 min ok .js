// ======================================================================// üé¨ generate.js ‚Äî Script Builder YouTube Over60 (7‚Äì10 min reali Fliki)// Con Boost Mode, Hook Surgeon Mode, Fliki AutoScene Marker// ======================================================================import express from "express";import { callAI } from "../services/aiService.js";import { estimateSceneDurations } from "../utils/wordDuration.js";const router = express.Router();// üéØ RUOLI CONSENTITIconst validRoles = [  "HOOK",  "PROBLEMA",  "SPIEGAZIONE",  "CAUSE",  "SOLUZIONI",  "STILE DI VITA",  "BENEFICI",  "MOTIVAZIONE",  "CTA"];// Marker per Fliki AutoScene Modeconst SCENE_MARKER = "[SCENE_CHANGE]";// Boost Mode: Aggiunge domanda strategica ogni 3 scenefunction applyBoostMode(text, index) {  if ((index + 1) % 3 === 0) {    return text.trim() + " Quale di queste idee ti rispecchia di pi√π?";  }  return text;}/** * POST /generate/script */router.post("/script", async (req, res) => {  try {    const { idea } = req.body;    if (!idea) {      return res.status(400).json({ error: "Missing 'idea' field" });    }    // üîπ Prompt finale, ottimizzato, stabile, senza frammentazione    const prompt = `Sei uno YouTube Script Builder di livello Top, specializzato in pubblico Over60.Genera SOLO JSON valido, senza testo esterno.üéØ OBIETTIVO:- Voce: Michele, 145 parole/minuto- Durata finale: 7‚Äì10 minuti (minimo 1100 - massimo 1450 parole)- Scene: tra 18 e 28- Ogni scena tra 65 e 90 parole- Hook Surgeon Mode ‚Üí Prima scena deve essere la pi√π forte possibile, altissimo CTR- Boost Mode ‚Üí Inserisci una domanda diretta ogni 3 scene (naturale, non forzata)- Fliki AutoScene Mode ‚Üí Inserisci SEMPRE il marker finale: ${SCENE_MARKER}üìå FORMATO JSON:{  "video_title": "",  "scenes": [    { "id": 1, "role": "HOOK", "text": "..." },    { "id": 2, "role": "PROBLEMA", "text": "..." }  ]}‚ö†Ô∏è REGOLE FERREE:- Nessun markdown, nessun **bold**, nessun elenco- Nessun a capo manuale o \\n- Nessun titolo se non video_title- Niente ‚ÄúScene 1‚Äù o ‚ÄúIn questa scena‚Äù- Linguaggio naturale, narrativo, empatico, conversazionale- Vietato contenuto medico o clinico- Ruoli ammessi: HOOK, PROBLEMA, SPIEGAZIONE, CAUSE, SOLUZIONI, STILE DI VITA, BENEFICI, MOTIVAZIONE, CTAüé§ TONO:Caldo, umano, incoraggiante, con ritmo narrativo continuo, alta retention.Argomento del video:"${idea}"Rispondi SOLO con JSON valido.    `;    // üß† Chiamata AI    const aiResponse = await callAI(prompt, {      model: "gpt-4o-mini",      temperature: 0.7,      max_tokens: 4500,    });    // Validazione    if (!aiResponse || !aiResponse.scenes || !Array.isArray(aiResponse.scenes)) {      throw new Error("Invalid AI response format");    }    // üõ† Normalizzazione scene + Boost Mode + Marker automatico    aiResponse.scenes = aiResponse.scenes.map((scene, index) => {      const cleaned = { ...scene };      // Fallback id      cleaned.id = typeof cleaned.id === "number" ? cleaned.id : index + 1;      // Ruolo valido      cleaned.role = validRoles.includes(cleaned.role)        ? cleaned.role        : "CTA";      // Testo pulito      cleaned.text = String(cleaned.text || "").trim();      // Boost Mode ‚Üí domanda strategica ogni 3 scene      cleaned.text = applyBoostMode(cleaned.text, index);      // Fliki Scene Marker      cleaned.text = cleaned.text + " " + SCENE_MARKER;      return cleaned;    });    // ‚è± Calcolo durata    const {      scenesWithTime,      totalWords,      totalDurationSec,      totalDurationFormatted,    } = estimateSceneDurations(aiResponse.scenes);    // üöÄ Risposta    return res.json({      success: true,      result: {        video_title: aiResponse?.video_title || null,        voiceProfile: { id: "michele", label: "Michele (naturale, calmo)", wpm: 145 },        totalWords,        estimatedDurationSec: totalDurationSec,        estimatedDurationFormatted: totalDurationFormatted,        sceneCount: scenesWithTime.length,        scenes: scenesWithTime,      },    });  } catch (err) {    console.error("‚ùå /generate/script error:", err);    return res.status(500).json({ error: "Internal Server Error" });  }});export default router;