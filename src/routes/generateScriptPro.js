// ============================================================// ðŸŽ¬ generateScriptPro.js â€” Premium Script Builder (8â€“11 minuti)// ============================================================import express from "express";import { callAI } from "../services/aiService.js";import { estimateSceneDurations } from "../utils/wordDuration.js";import {  getDefaultProfile,  getProfileByHandle} from "../services/profileManager.js";   // âœ… FIX DEFINITIVOconst router = express.Router();const validRoles = [  "HOOK",  "PROBLEMA",  "SPIEGAZIONE",  "CAUSE",  "SOLUZIONI",  "STILE DI VITA",  "BENEFICI",  "MOTIVAZIONE",  "CTA"];/** * POST /generate/scriptPro * ModalitÃ  premium: * - Hook Surgeon â†’ HOOK aggressivo per retention * - Boost Mode â†’ domanda strategica ogni 3 scene * - Fliki AutoScene â†’ marker [SCENE_CHANGE] automatico */router.post("/scriptPro", async (req, res) => {  try {    const { idea, handle, boostMode = true, hookSurgeon = true, autoSceneMarkers = true } =      req.body;    if (!idea) {      return res.status(400).json({ error: "Missing 'idea' field" });    }    const profile = handle ? getProfileByHandle(handle) : getDefaultProfile();    const prompt = `Sei "Zen YouTube Script Pro", uno script builder premium per il canale "${profile.channelName}".Pubblico: ${profile.targetAudience.join(", ")} (Over 50, Over 60, Over 70).Nicho: ${profile.niche}.Tono: ${profile.tone}.Genera SOLO JSON valido, nessun testo esterno.ðŸŽ¯ MODALITÃ€ PREMIUM:1) Hook Surgeon:   - HOOK ultra forte, aggressivo, emozionale, Over50/60/70   - cita il canale "${profile.channelName}"2) Boost Mode:   - Domanda allo spettatore ogni 3 scene3) Fliki AutoScene:   - Aggiungi alla fine di OGNI scena: [SCENE_CHANGE]ðŸŽ¯ PARAMETRI:- Durata target: 8â€“11 minuti- Voce: Michele (145 wpm)- Totale parole: 1150â€“1600- Scene: 22â€“32- Parole per scena: 45â€“65ðŸ“Œ JSON:{  "video_title": "",  "scenes": [    { "id": 1, "role": "HOOK", "text": "..." }  ]}Argomento:"${idea}"Rispondi SOLO con JSON.`;    const aiRaw = await callAI(prompt, {      model: "gpt-4o-mini",      temperature: 0.75,      max_tokens: 6000    });    const aiResponse = typeof aiRaw === "string" ? JSON.parse(aiRaw) : aiRaw;    if (!aiResponse?.scenes || !Array.isArray(aiResponse.scenes)) {      throw new Error("Invalid AI response format from /generate/scriptPro");    }    // Normalizzazione + AutoScene markers    let scenes = aiResponse.scenes.map((scene, index) => {      const cleaned = { ...scene };      cleaned.id = typeof cleaned.id === "number" ? cleaned.id : index + 1;      cleaned.role = validRoles.includes(cleaned.role)        ? cleaned.role        : "CTA";      cleaned.text = typeof cleaned.text === "string"        ? cleaned.text        : String(cleaned.text || "");      if (autoSceneMarkers && !cleaned.text.includes("[SCENE_CHANGE]")) {        cleaned.text = `${cleaned.text.trim()} [SCENE_CHANGE]`;      }      return cleaned;    });    // Boost Mode â†’ aggiungiamo domande    if (boostMode && scenes.length >= 6) {      for (let i = 2; i < scenes.length; i += 3) {        if (!/[?ï¼Ÿ]/.test(scenes[i].text)) {          scenes[i].text = `${scenes[i].text.trim()} Quale di queste situazioni ti descrive di piÃ¹?`;          if (autoSceneMarkers && !scenes[i].text.includes("[SCENE_CHANGE]")) {            scenes[i].text = `${scenes[i].text.trim()} [SCENE_CHANGE]`;          }        }      }    }    // Hook Surgeon â†’ potenziamo scena 1 se serve    if (hookSurgeon && scenes[0]) {      if (scenes[0].text.length < 140) {        scenes[0].text =          `Se hai piÃ¹ di 50 anni e vuoi davvero migliorare la tua salute, questo video del canale Zen Salute e Benessere Ã¨ per te. ` +          scenes[0].text;        if (autoSceneMarkers && !scenes[0].text.includes("[SCENE_CHANGE]")) {          scenes[0].text = `${scenes[0].text.trim()} [SCENE_CHANGE]`;        }      }    }    // Calcolo durata    const {      scenesWithTime,      totalWords,      totalDurationSec,      totalDurationFormatted    } = estimateSceneDurations(scenes);    return res.json({      success: true,      result: {        video_title: aiResponse?.video_title || null,        profile,        voiceProfile: {          id: "michele",          label: "Michele (naturale, calmo)",          wpm: 145        },        totalWords,        estimatedDurationSec: totalDurationSec,        estimatedDurationFormatted: totalDurationFormatted,        sceneCount: scenesWithTime.length,        scenes: scenesWithTime      }    });  } catch (err) {    console.error("âŒ /generate/scriptPro error:", err);    return res.status(500).json({ error: "Internal Server Error" });  }});export default router;