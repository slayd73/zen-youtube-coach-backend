// ============================================================// üé¨ generate.js ‚Äî Script Builder YouTube Over60 (7‚Äì10 minuti)// ============================================================import express from "express";import { callAI } from "../services/aiService.js";import { estimateSceneDurations } from "../utils/wordDuration.js";const router = express.Router();// üéØ RUOLI CONSENTITIconst validRoles = [  "HOOK",  "PROBLEMA",  "SPIEGAZIONE",  "CAUSE",  "SOLUZIONI",  "STILE DI VITA",  "BENEFICI",  "MOTIVAZIONE",  "CTA"];/** * POST /generate/script * Genera uno script YouTube per Over60 (7‚Äì10 min con voce Michele 145 wpm) */router.post("/script", async (req, res) => {  try {    const { idea } = req.body;    if (!idea) {      return res.status(400).json({ error: "Missing 'idea' field" });    }    // üß† PROMPT tarato sui 7‚Äì10 minuti REALI    const prompt = `Sei uno YouTube Script Builder professionale specializzato in contenuti per pubblico Over60.Genera SOLO JSON valido, nessun testo esterno.üéØ OBIETTIVO DURATA:- Voce: Michele, 145 parole al minuto- Durata finale: 8‚Äì10 minuti reali- Totale parole: idealmente tra 2000 e 2300 paroleüé¨ STRUTTURA:- Dividi lo script in 35‚Äì50 scene- Ogni scena deve avere tra 180 e 220 parole- id numerico progressivo- role deve essere uno di:  HOOK, PROBLEMA, SPIEGAZIONE, CAUSE, SOLUZIONI, STILE DI VITA, BENEFICI, MOTIVAZIONE, CTA- text: linguaggio naturale, colloquiale, caldo, empatico, NON medicoüìå FORMATO FINALE JSON (OBBLIGATORIO):{  "video_title": "",  "scenes": [    { "id": 1, "role": "HOOK", "text": "..." },    { "id": 2, "role": "PROBLEMA", "text": "..." }  ]}‚ö†Ô∏è REGOLE FERREE:- Nessun markdown (no **bold**, no liste, no titoli)- Nessun \\n, nessun a capo manuale- Nessuna frase tipo "In questa scena..." o "Scene 1"- Vietato usare ruoli diversi da quelli indicati- Tono: calmo, umano, incoraggiante, vicino all‚Äôascoltatore Over60Argomento del video:"${idea}"Rispondi SOLO con JSON valido nel formato indicato.`;    // üß† Chiamata al modello AI    const aiResponse = await callAI(prompt, {      model: "gpt-4o-mini",      temperature: 0.7,      max_tokens: 4500    });    // üõ° Validazione base    if (!aiResponse || !aiResponse.scenes || !Array.isArray(aiResponse.scenes)) {      throw new Error("Invalid AI response format");    }    // üö¶ Normalizzazione ruoli    aiResponse.scenes = aiResponse.scenes.map((scene, index) => {      const cleaned = { ...scene };      // fallback id se mancante      if (typeof cleaned.id !== "number") {        cleaned.id = index + 1;      }      // ruolo non valido ‚Üí CTA      if (!validRoles.includes(cleaned.role)) {        cleaned.role = "CTA";      }      // text sempre stringa      if (typeof cleaned.text !== "string") {        cleaned.text = String(cleaned.text || "");      }      return cleaned;    });    // ‚è±Ô∏è Stima durata e parole    const {      scenesWithTime,      totalWords,      totalDurationSec,      totalDurationFormatted    } = estimateSceneDurations(aiResponse.scenes);    // üì§ Risposta finale    return res.json({      success: true,      result: {        video_title: aiResponse?.video_title || null,        voiceProfile: {          id: "michele",          label: "Michele (naturale, calmo)",          wpm: 145        },        totalWords,        estimatedDurationSec: totalDurationSec,        estimatedDurationFormatted: totalDurationFormatted,        sceneCount: scenesWithTime.length,        scenes: scenesWithTime      }    });  } catch (err) {    console.error("‚ùå /generate/script error:", err);    return res.status(500).json({ error: "Internal Server Error" });  }});export default router;