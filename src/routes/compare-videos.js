// =====================================================================//  ðŸ”¥ /compare-videos.js â€” VERSIONE TOP BEST ULTRA-PREMIUM//  Confronto visivo + metadata + CTR prediction tra due o piÃ¹ video.//  Analisi: titoli, descrizioni, thumbnail, SEO, psicologia del click.//  Modulo fondamentale di Zen YouTube Coach Pro.// =====================================================================import express from "express";import { callAIModel } from "../services/aiEngine.js";import {  getProfileByHandle,  getDefaultProfile} from "../services/profileManager.js";const router = express.Router();// ---------------------------------------------------------// Utils// ---------------------------------------------------------function extractValidJson(text) {  try {    const first = text.indexOf("{");    const last = text.lastIndexOf("}");    if (first === -1 || last === -1) return null;    return text.substring(first, last + 1);  } catch {    return null;  }}function autoFixJsonString(str) {  if (!str || typeof str !== "string") return str;  return str    .replace(/,\s*}/g, "}")    .replace(/,\s*]/g, "]")    .replace(/[\u2018\u2019]/g, "'")    .replace(/[\u201C\u201D]/g, '"');}// ---------------------------------------------------------// Prompt Ultra-Premium// ---------------------------------------------------------function buildComparePrompt(videos, profile, primaryId) {  const serialized = videos    .map((v, i) => {      return `[VIDEO ${i + 1}]id: ${v.id}title: ${v.title}description: ${v.description}thumbnail_url: ${v.thumbnail}notes: ${v.notes}`;    })    .join("\n\n");  return `Sei "Zen YouTube Coach Pro â€” CompareVideos Engine", versione TOP BEST Ultra-Premium.Confronta i seguenti video YouTube in base a:- Titolo (CTR, chiarezza, psicologia, promessa)- Descrizione (SEO, struttura, keyword)- Thumbnail (clickability, contrasto, emozione)- Titolo + Thumbnail sinergia- Target Over50/60/70- Predictive CTR- Potenziale virale- Debolezze del video primario (primaryId: ${primaryId || "non definito"})Video forniti:${serialized}Genera SOLO il seguente JSON:{  "videoCount": 0,  "primaryId": "",  "globalInsights": {    "overallWinner": "",    "reasonWinner": "",    "audienceFitOver50": "",    "audienceFitOver60": "",    "audienceFitOver70": "",    "patternDetected": [],    "commonMistakes": []  },  "rankingCTR": [    {      "id": "",      "titleCTRScore": 0,      "thumbnailCTRScore": 0,      "seoScore": 0,      "finalCTRPrediction": 0,      "reason": ""    }  ],  "perVideo": [    {      "id": "",      "titleAnalysis": {        "score": 0,        "clarity": "",        "hookPower": "",        "emotionalTriggers": [],        "improvements": []      },      "thumbnailAnalysis": {        "score": 0,        "clarity": "",        "emotion": "",        "visualProblems": [],        "improvements": []      },      "titleThumbnailSynergy": "",      "seo": {        "positiveKeywords": [],        "missingKeywords": []      },      "predictiveCTR": 0,      "strengths": [],      "weaknesses": []    }  ],  "recommendedFixForPrimary": {    "betterTitleIdea": "",    "betterThumbnailConcept": "",    "betterDescription": "",    "seoFixes": [],    "overallImprovement": ""  }}REGOLE:- Nessun testo fuori dal JSON.- Nessuna spiegazione.- Se un campo Ã¨ sconosciuto, usa "" o [] o 0.`;}// ---------------------------------------------------------// Endpoint Ultra-Premium// ---------------------------------------------------------router.post("/compare-videos-pro", async (req, res) => {  try {    const { videos, primaryId, profileHandle } = req.body;    if (!videos || !Array.isArray(videos) || videos.length < 2) {      return res.status(400).json({        success: false,        error: "Servono almeno 2 video completi (titolo, descrizione, thumbnail)."      });    }    const cleanedVideos = videos.map((v, index) => ({      id: v.id || `video_${index + 1}`,      title: v.title || "",      description: v.description || "",      thumbnail: v.thumbnail || "",      notes: v.notes || ""    }));    const profile =      getProfileByHandle(profileHandle) || getDefaultProfile();    const prompt = buildComparePrompt(cleanedVideos, profile, primaryId);    const aiResponse = await callAIModel(prompt);    // JSON extraction    let jsonRaw = extractValidJson(aiResponse);    if (!jsonRaw) {      jsonRaw = extractValidJson(autoFixJsonString(aiResponse));    }    if (!jsonRaw) {      return res.status(500).json({        success: false,        error: "Impossibile estrarre un JSON valido.",        raw: aiResponse      });    }    const fixedJson = autoFixJsonString(jsonRaw);    let parsed;    try {      parsed = JSON.parse(fixedJson);    } catch (err) {      return res.status(500).json({        success: false,        error: "JSON non valido dopo il fix.",        original: aiResponse,        extracted: jsonRaw,        fixed: fixedJson      });    }    return res.json({      success: true,      meta: {        profile: profile.label,        primaryId: primaryId || null      },      result: parsed    });  } catch (err) {    console.error("ERRORE COMPARE VIDEOS PRO:", err);    return res.status(500).json({      success: false,      error: "Errore interno compare-videos-pro",      details: err.message    });  }});export default router;