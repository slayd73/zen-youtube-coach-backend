// ======================================================// üÜö /compare-videos ‚Äî Confronto multi-video PRO Ultra 2025// Confronta 2‚Äì5 video (titolo + transcript) per pubblico Over 50/60/70// ======================================================import express from "express";import { getTranscript } from "../services/transcriptService.js";import { getYouTubeTitle } from "../services/youtubeTitleService.js";import { callAIModel } from "../services/aiEngine.js";const router = express.Router();/** * Body atteso: * { *   "audience": "over60", *   "videos": [ *     { "label": "Mio Video", "videoIdOrUrl": "https://www.youtube.com/watch?v=..." }, *     { "label": "Competitor 1", "videoIdOrUrl": "..." }, *     { "label": "Competitor 2", "videoIdOrUrl": "..." } *   ] * } */router.post("/", async (req, res) => {  try {    const { audience = "over60", videos = [] } = req.body || {};    if (!Array.isArray(videos) || videos.length < 2) {      return res.status(400).json({        success: false,        message: "Servono almeno 2 video in 'videos'."      });    }    // Limite di sicurezza (non ha senso confrontarne 20)    const limitedVideos = videos.slice(0, 5);    // 1Ô∏è‚É£ Recupero transcript + titolo per ogni video    const enriched = [];    for (const v of limitedVideos) {      if (!v || !v.videoIdOrUrl) continue;      const label = v.label || v.videoIdOrUrl;      // Transcript      const t = await getTranscript(v.videoIdOrUrl);      if (!t || t.error) {        console.warn("‚ö†Ô∏è Impossibile ottenere transcript per:", v.videoIdOrUrl);        continue;      }      const transcriptText = t.aiText || t.continuousText;      if (!transcriptText || transcriptText.length < 80) {        console.warn("‚ö†Ô∏è Transcript troppo corto per:", v.videoIdOrUrl);        continue;      }      // Titolo      const title = await getYouTubeTitle(v.videoIdOrUrl);      enriched.push({        label,        videoIdOrUrl: v.videoIdOrUrl,        title: title || "Titolo non recuperato",        transcript: transcriptText      });    }    if (enriched.length < 2) {      return res.status(400).json({        success: false,        message:          "Non √® stato possibile ottenere transcript/titoli sufficienti per confrontare i video."      });    }    // 2Ô∏è‚É£ Prompt per AI ‚Äî confronto avanzato PRO    const prompt = `Sei "Zen YouTube Coach Pro", un analista YouTube avanzato per pubblico ${audience}(Over 50, Over 60, Over 70).Ti passo una lista di video con:- label (es. "Mio Video", "Competitor 1")- url- title (titolo reale YouTube, se disponibile)- transcript (testo del video)Devi:1) Confrontare HOOK, STRUTTURA, RETENTION, VALORE, EMOZIONE, TITOLO per ogni video2) Valutare quanto ogni video √® adatto al pubblico Over 50/60/703) Fare un RANKING chiaro (1 = migliore, N = peggiore)4) Evidenziare cosa rubare (whatToSteal) dai migliori5) Evidenziare cosa evitare (whatToAvoid) dai peggiori6) Trovare pattern condivisi (patternShared)7) Suggerire idee di CTA e miglioramenti globaliVideo (JSON):${JSON.stringify(enriched, null, 2)}‚ö†Ô∏è Rispondi SOLO con JSON valido, con questa struttura:{  "ranking": [    {      "label": "Mio Video",      "position": 1,      "scoreGlobal": 0-10,      "reason": "perch√© √® al primo posto"    }  ],  "perVideo": {    "Mio Video": {      "hookScore": 0-10,      "retentionScore": 0-10,      "valueScore": 0-10,      "emotionScore": 0-10,      "titleScore": 0-10,      "notes": "commento sintetico"    },    "Competitor 1": {      "hookScore": 0-10,      "retentionScore": 0-10,      "valueScore": 0-10,      "emotionScore": 0-10,      "titleScore": 0-10,      "notes": "commento sintetico"    }  },  "whatToSteal": ["...", "..."],  "whatToAvoid": ["...", "..."],  "patternShared": ["...", "..."],  "ctaIdeas": ["...", "..."],  "over50Notes": "commento specifico per Over 50/60/70"}`.trim();    const raw = await callAIModel(prompt, "text", {      provider: "groq",      temperature: 0.25,      maxTokens: 6000    });    const extractJson = (txt) => {      try {        const first = txt.indexOf("{");        const last = txt.lastIndexOf("}");        if (first === -1 || last === -1) return null;        return JSON.parse(txt.substring(first, last + 1));      } catch (e) {        console.error("‚ùå JSON parse error /compare-videos:", e.message);        return null;      }    };    const parsed = extractJson(raw);    if (!parsed) {      return res.status(500).json({        success: false,        message: "AI ha prodotto JSON non valido in /compare-videos.",        raw      });    }    return res.json({      success: true,      audience,      videosCount: enriched.length,      videos: enriched.map((v) => ({        label: v.label,        url: v.videoIdOrUrl,        title: v.title      })),      data: parsed    });  } catch (err) {    console.error("‚ùå /compare-videos ERROR:", err);    return res.status(500).json({      success: false,      message: "Errore interno /compare-videos: " + err.message    });  }});export default router;