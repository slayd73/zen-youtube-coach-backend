// ======================================================================// ðŸ” analyze-transcript.js â€” Versione Ultra-Premium V4 (2025)// Analisi completa per pubblico Over50/60/70// KPI â€¢ Hook â€¢ Storytelling â€¢ Retention â€¢ SEO â€¢ Energia â€¢ CTA// ======================================================================import express from "express";import { callAIModel } from "../services/aiEngine.js";import {  getProfileByHandle,  getDefaultProfile,} from "../services/profileManager.js";const router = express.Router();// -------------------------------------------------------------// JSON Extractor robusto (taglia tutto fino al primo { e ultimo })// -------------------------------------------------------------function extractJSON(raw) {  try {    const first = raw.indexOf("{");    const last = raw.lastIndexOf("}");    if (first === -1 || last === -1) return null;    return raw.substring(first, last + 1);  } catch {    return null;  }}// ======================================================================// ðŸš€ POST /analyze-transcript// Body:// {//   "transcript": "...",//   "videoId": "...",//   "audience": "over50|over60|over70",//   "debug": false// }// ======================================================================router.post("/", async (req, res) => {  try {    const {      transcript,      videoId = null,      audience = "over60",      debug = false,    } = req.body || {};    if (!transcript || transcript.trim().length < 40) {      return res.status(400).json({        success: false,        error: true,        message:          "Transcript troppo breve o mancante. Incolla un transcript valido.",      });    }    // Profilo Over 50/60/70    const profile =      getProfileByHandle(audience.toLowerCase()) || getDefaultProfile();    // ðŸ”¥ Prompt Ultra-Premium V4    const prompt = `Sei "Zen YouTube Coach Pro", il piÃ¹ avanzato analista YouTube specializzatonel pubblico ${profile.label}.Analizza questo transcript e restituisci TUTTO in JSON VALIDO, SENZA testo fuori dal JSON.TRANSCRIPT:${transcript}Restituisci un JSON ESATTAMENTE con questa struttura:{  "ZenCoachScore": {    "punteggio": 0-100,    "motivoSintetico": "..."  },  "Hook": {    "valutazione": "forte|medio|debole",    "perche": "...",    "come_migliorarlo": "..."  },  "MicroNarrazione": {    "presente": true|false,    "qualita": "alta|media|bassa",    "perche": "..."  },  "Primi30Secondi": {    "intensita": "alta|media|bassa",    "puntiForti": ["...", "..."],    "debolezze": ["...", "..."],    "retentionStimata": "alta|media|bassa"  },  "StrutturaNarrativa": {    "hookShock": true|false,    "storiaPersonale": true|false,    "rivelazione": true|false,    "soluzioni": true|false,    "trasformazione": true|false,    "ctaPresente": true|false  },  "StileTonale": {    "tono": "empatico|calmo|energico|motivazionale|tecnico",    "energia": "alta|media|bassa",    "adeguatoPerPubblico": true|false  },  "Linguaggio": {    "complessita": "semplice|medio|complesso",    "chiarezza": "alta|media|bassa",    "erroriComuni": ["..."]  },  "ContenutiChiave": {    "keywordsEstratte": ["...", "...", "..."],    "argomentiPrincipali": ["...", "...", "..."],    "promesse": ["...", "..."],    "soluzioniOfferte": ["...", "..."]  },  "CTA": {    "presente": true|false,    "efficacia": "alta|media|bassa",    "come_migliorarla": "..."  },  "ConsigliStrategici": {    "perPubblicoOver50_60_70": ["...", "..."],    "perCTR": ["...", "..."],    "perRetention": ["...", "..."],    "perStorytelling": ["...", "..."]  },  "TitoliSuggeriti": [    {      "titolo": "...",      "angolo": "...",      "promessa": "..."    }  ]}REGOLE:- Rispondi SOLO con JSON valido.- Nessuna frase fuori dal JSON.- Nessuna spiegazione.- Usa sempre il soggetto â€œtuâ€ (seconda persona).- Ottimizza lâ€™analisi per pubblico maturo (over50/60/70).    `.trim();    if (debug) console.log("ðŸ“¤ Prompt inviato all'AI...");    // ðŸ”¥ AI Call    const raw = await callAIModel(prompt, {      model: "gpt-4o-mini",      temperature: 0.35,      maxTokens: 7000,    });    const jsonBlock = extractJSON(raw);    if (!jsonBlock) {      return res.status(200).json({        success: false,        warning: true,        message: "La risposta AI non contiene JSON valido.",        rawAIResponse: raw,      });    }    const parsed = JSON.parse(jsonBlock);    return res.json({      success: true,      audience: profile.label,      videoId,      analytics: parsed,      rawAIResponse: raw,    });  } catch (error) {    console.error("âŒ Errore in /analyze-transcript:", error);    return res.status(500).json({      success: false,      error: true,      message: "Errore interno nell'analisi del transcript.",      details: error.message,    });  }});export default router;