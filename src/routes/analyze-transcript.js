// ======================================================// ðŸ” /analyze-transcript â€” Analisi transcript Over 50/60/70// ======================================================import express from "express";import { getTranscript } from "../services/transcriptService.js";import { callAIModel } from "../services/aiEngine.js";import {  naturalParagraphsFromText,  validateTranscriptQuality} from "../services/transcriptUtils.js";const router = express.Router();function extractJsonObject(text) {  if (!text || typeof text !== "string") return null;  const first = text.indexOf("{");  const last = text.lastIndexOf("}");  if (first === -1 || last === -1) return null;  return text.substring(first, last + 1);}function safeParse(text) {  try {    return JSON.parse(text);  } catch (e) {    console.error("âŒ JSON parse error /analyze-transcript:", e);    return null;  }}router.post("/", async (req, res) => {  try {    const {      videoIdOrUrl,      transcript,      audience = "over60",      profileHandle = "default"    } = req.body || {};    if (!videoIdOrUrl && !transcript) {      return res.status(400).json({        success: false,        message:          "Devi passare almeno videoIdOrUrl oppure transcript per /analyze-transcript."      });    }    let baseText = transcript;    let transcriptMeta = {};    if (!baseText && videoIdOrUrl) {      const t = await getTranscript(videoIdOrUrl);      if (t.error) {        return res.status(500).json({          success: false,          message: t.message || "Impossibile recuperare transcript."        });      }      baseText = t.aiText || t.continuousText;      transcriptMeta = {        provider: t.provider,        videoId: t.videoId || null,        transcriptLength: (t.aiText || t.continuousText || "").length      };    }    if (!baseText || baseText.trim().length < 50) {      return res.status(400).json({        success: false,        message:          "Transcript troppo corto o mancante per analisi significativa."      });    }    const quality = validateTranscriptQuality(baseText);    const paragraphs = naturalParagraphsFromText(baseText, 260);    const prompt = `Sei "YouTube Coach Pro", un analista di script YouTube per pubblico Over 50/60/70.Analizza il seguente transcript e restituisci SOLO un JSON con questa struttura esatta:{  "summary": {    "oneLine": "...",    "short": "...",    "keyPromise": "..."  },  "hook": {    "hookScore": 0-10,    "hookType": "storia personale | shock | domanda diretta | beneficio secco | elenco problemi | altro",    "whatWorks": ["..."],    "whatIsWeak": ["..."],    "improvedHooks": ["...", "...", "..."]  },  "structure": {    "clarityScore": 0-10,    "emotionalScore": 0-10,    "didacticScore": 0-10,    "hasClearSteps": true,    "notes": "...",    "suggestedStructure": ["...", "...", "..."]  },  "retention": {    "riskScore": 0-10,    "riskyMoments": [      {        "approxSection": "inizio | metÃ  | fine",        "reason": "..."      }    ],    "suggestedFixes": ["...", "..."]  },  "audienceOver_50_60_70": {    "targetDetected": "over50 | over60 | over70 | misto | non chiaro",    "fitScore": 0-10,    "languageNotes": ["...", "..."],    "empathyScore": 0-10,    "painPointsDetected": ["...", "..."]  },  "seoAndContentIdeas": {    "keywordIdeas": ["...", "..."],    "possibleTitles": ["...", "..."],    "shortsIdeas": ["...", "..."]  }}Regole:- Rispondi SOLO con JSON valido.- Nessun testo fuori dal JSON.- Niente commenti, niente spiegazioni.Transcript:"""${baseText}"""`.trim();    const raw = await callAIModel(prompt, "text", {      provider: "groq",      temperature: 0.25,      maxTokens: 4800    });    if (!raw) {      return res.status(502).json({        success: false,        message: "AI non ha restituito risposta in /analyze-transcript."      });    }    const jsonStr = extractJsonObject(raw);    const parsed = safeParse(jsonStr);    if (!parsed) {      return res.status(500).json({        success: false,        message: "AI ha prodotto JSON non valido in /analyze-transcript.",        raw      });    }    return res.json({      success: true,      meta: {        profileHandle,        audience,        transcriptQuality: quality,        transcriptParagraphsCount: paragraphs.length,        ...transcriptMeta      },      analysis: parsed    });  } catch (err) {    console.error("âŒ /analyze-transcript ERROR:", err);    return res.status(500).json({      success: false,      message: "Errore interno /analyze-transcript: " + err.message    });  }});export default router;