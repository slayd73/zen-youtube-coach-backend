// ======================================================// ðŸ“Š /analyze â€” Analisi "video completo" (via transcript)// ======================================================import express from "express";import { getTranscript } from "../services/transcriptService.js";import { callAIModel } from "../services/aiEngine.js";const router = express.Router();router.post("/", async (req, res) => {  try {    const {      videoIdOrUrl,      audience = "over60"    } = req.body || {};    if (!videoIdOrUrl) {      return res.status(400).json({        success: false,        message: "Devi passare videoIdOrUrl per /analyze."      });    }    const t = await getTranscript(videoIdOrUrl);    if (t.error) {      return res.status(500).json({        success: false,        message: t.message || "Impossibile recuperare transcript."      });    }    const transcriptText = t.aiText || t.continuousText;    if (!transcriptText || transcriptText.length < 50) {      return res.status(400).json({        success: false,        message: "Transcript troppo corto o mancante per /analyze."      });    }    const prompt = `Sei "YouTube Coach Pro". Analizza questo video per il pubblico ${audience}.Transcript:"""${transcriptText}"""Devi restituire SOLO un JSON con:{  "hookScore": 0-10,  "structureScore": 0-10,  "clarityScore": 0-10,  "valueScore": 0-10,  "overallScore": 0-10,  "hookNotes": "...",  "structureNotes": "...",  "clarityNotes": "...",  "valueNotes": "...",  "suggestedImprovements": ["...", "...", "..."],  "titleIdeas": ["...", "..."],  "shortsIdeas": ["...", "..."]}`.trim();    const raw = await callAIModel(prompt, "text", {      provider: "groq",      temperature: 0.25,      maxTokens: 4000    });    const first = raw.indexOf("{");    const last = raw.lastIndexOf("}");    let parsed = null;    if (first !== -1 && last !== -1) {      try {        parsed = JSON.parse(raw.substring(first, last + 1));      } catch (e) {        console.error("âŒ JSON parse error /analyze:", e);      }    }    if (!parsed) {      return res.status(500).json({        success: false,        message: "AI ha prodotto JSON non valido in /analyze.",        raw      });    }    return res.json({      success: true,      meta: {        audience,        provider: t.provider,        videoId: t.videoId || null      },      analysis: parsed    });  } catch (err) {    console.error("âŒ /analyze ERROR:", err);    return res.status(500).json({      success: false,      message: "Errore interno /analyze: " + err.message    });  }});export default router;