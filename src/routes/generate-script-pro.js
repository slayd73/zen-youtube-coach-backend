// ======================================================================// üé¨ generate-script-pro.js ‚Äî Ultra-Premium Script Generator V4// Zen YouTube Coach Pro ‚Äî 2025// Output strutturato, JSON pulito, scenes per Fliki, outline avanzato// ======================================================================import express from "express";import { callAIModel } from "../services/aiEngine.js";import { getProfileByHandle, getDefaultProfile } from "../services/profileManager.js";const router = express.Router();// ======================================================================// üß∞ JSON Extractor ‚Äî prende SOLO il blocco JSON valido// ======================================================================function extractJsonObject(str) {  if (!str) return null;  try {    const first = str.indexOf("{");    const last = str.lastIndexOf("}");    if (first === -1 || last === -1) return null;    return str.substring(first, last + 1);  } catch {    return null;  }}// ======================================================================// üöÄ POST /generate-script-pro// ======================================================================router.post("/", async (req, res) => {  try {    const {      topic,      audience = "over60",      durationMinutes = 8,      language = "it",    } = req.body;    if (!topic) {      return res.status(400).json({        success: false,        message: "‚ùå Devi fornire almeno il campo 'topic'.",      });    }    // Profilo pubblico Over50/60/70    const profile = getProfileByHandle(audience) || getDefaultProfile();    // Word count stimato per durata    const targetWPM = 140;    const estimatedWordCount = durationMinutes * targetWPM;    // ==================================================================    // üß† PROMPT ‚Äî Versione V4 Ultra Premium    // ==================================================================    const prompt = `Sei "Zen YouTube Coach Pro" ‚Äî versione Ultra Premium 2025.Crea uno script completo in stile trailer emozionale per un pubblico ${profile.label}.Obiettivo:- Durata: ${durationMinutes} minuti- Lingua: ${language}- Topic: "${topic}"- Canale: Zen Salute e Benessere- Output SOLO in JSON validoSTRUTTURA JSON RICHIESTA:{  "meta": {    "topic": "",    "audienceLabel": "",    "language": "",    "estimatedDurationMinutes": 0,    "targetWPM": 0,    "estimatedWordCount": 0  },  "script": {    "hook": "",    "introCanale": "",    "sezioniPrincipali": [      { "titoloSezione": "", "testo": "" }    ],    "consiglioExtra": "",    "outro": ""  },  "outline": {    "bulletPoints": [],    "promessaCentrale": "",    "problemaPrincipale": "",    "trasformazionePromessa": ""  },  "scenes": [    {      "id": 1,      "role": "",      "label": "",      "text": "",      "wordCount": 0,      "estimatedDurationSec": 0    }  ]}REGOLE DI STILE:- Stile narrativo-emozionale- Ritmo rapido, micro-storie, frasi corte- Hook fortissimo nelle prime righe- Target Over50/60/70: empatia, semplicit√†, chiarezza- Evita linguaggio tecnico- Ogni sezione deve essere leggibile e naturale- Crea scenes per Fliki perfettamente separate- Nessun testo fuori dal JSON`.trim();    // ===============================    // üß† Chiamata AI    // ===============================    const aiResponse = await callAIModel(prompt, "text", {      temperature: 0.65,      maxTokens: 6000,    });    const jsonBlock = extractJsonObject(aiResponse);    if (!jsonBlock) {      return res.status(200).json({        success: false,        warning: true,        message: "La risposta AI non contiene JSON valido.",        rawAIResponse: aiResponse,      });    }    let parsed;    try {      parsed = JSON.parse(jsonBlock);    } catch (err) {      return res.status(200).json({        success: false,        message: "JSON non valido.",        rawAIResponse: aiResponse,      });    }    // ===============================    // üü¢ RISPOSTA OK    // ===============================    return res.status(200).json({      success: true,      meta: {        topic,        audienceLabel: profile.label,        language,        estimatedDurationMinutes: durationMinutes,        targetWPM,        estimatedWordCount,      },      script: parsed.script,      outline: parsed.outline,      scenes: parsed.scenes,      rawAIResponse: jsonBlock,    });  } catch (error) {    console.error("‚ùå ERRORE generate-script-pro:", error);    return res.status(500).json({      success: false,      message: "Errore interno nella generazione dello script.",      details: error.message,    });  }});export default router;