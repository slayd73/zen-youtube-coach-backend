// ======================================================// üöÄ /creator-rank ‚Äî Complete Creator Rank Engine// ======================================================import express from "express";import { callAIModel } from "../services/aiEngine.js";import { getProfileByHandle, getDefaultProfile } from "../services/profileManager.js";  // ‚úÖ FIX DEFINITIVOconst router = express.Router();router.post("/", async (req, res) => {  try {    const { handle, videos } = req.body;    if (!Array.isArray(videos) || videos.length < 2) {      return res.status(400).json({        error: true,        message: "Servono almeno 2 video in un array 'videos'."      });    }    if (videos.length > 8) {      return res.status(400).json({        error: true,        message: "Massimo 8 video per /creator-rank."      });    }    const channelProfile = handle      ? await getProfileByHandle(handle)      : await getDefaultProfile();    if (!channelProfile) {      return res.status(500).json({        error: true,        message: "Profilo canale non trovato."      });    }    const aiPrompt = `Sei un analista YouTube Pro per pubblico Over 50/60/70.VIDEO INPUT:${JSON.stringify(videos, null, 2)}PROFILO CANALE:${JSON.stringify(channelProfile, null, 2)}Valuta ogni video su:- CTR POTENZIALE- RETENTION POTENZIALE- IMPATTO EMOTIVO- FIT OVER 50/60/70- CTARispondi SOLO JSON:{  "ranking": [],  "scores": {},  "global_insights": {}}`;    const raw = await callAIModel(aiPrompt, "text");    const start = raw.indexOf("{");    const end = raw.lastIndexOf("}");    const parsed = JSON.parse(raw.slice(start, end + 1));    return res.status(200).json({      channelProfile,      rankEngine: parsed    });  } catch (err) {    console.error("‚ùå /creator-rank ERROR:", err);    return res.status(500).json({      error: "Errore interno server",      details: err.message    });  }});export default router;