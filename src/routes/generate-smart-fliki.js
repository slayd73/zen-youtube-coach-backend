// ===================================================================// üé¨ /generate-smart/fliki ‚Äî SMART Scene Builder per Fliki// JSON + CSV + XLSX ‚Äì Ottimizzato per voce MICHELE e target Over50/60/70// ===================================================================import express from "express";import { callAIModel } from "../services/aiService.js";import { safeParseJSON } from "../utils/jsonUtils.js";import * as XLSX from "xlsx";const router = express.Router();/** * üß† Funzione che genera le scene usando AI */async function buildFlikiScenes({ topic, trendData, dnaData, targetAge }) {  const prompt = `Genera uno script video in SCENE per Fliki, ottimizzato per:üéØ Pubblico: ${targetAge}, Over50/60/70üéôÔ∏è Voce: MICHELE (Fliki) ‚Äî maschile calda, empatica, ritmo naturale, non veloceüé• Stile: Educativo, rassicurante, umano, empatico, lento, autorevoleRegole di scrittura:- Massimo 14 parole per frase- Linguaggio semplice, naturale, umano- Frasi su righe separate per facilitare le pause vocali- Ogni SCENA deve avere:  - voiceText (testo parlato)  - overlayText (max 8 parole)  - visualSuggestion (immagine/video)  - durationSec (6‚Äì12 secondi)---üîé Usa questi dati reali (Trend & DNA di contenuti vincenti):üìä Trend Insights:${JSON.stringify(trendData, null, 2)}üß¨ DNA Contenuti Over50/60:${JSON.stringify(dnaData, null, 2)}---üìå OUTPUT FINALE *VALIDO JSON* ‚Äî niente testo fuori dalle {}{  "recommendedVoice": {    "name": "Michele",    "platform": "Fliki",    "tone": "caldo, empatico, rassicurante, adulto maturo"  },  "videoIntro": {    "voiceText": "",    "visualSuggestion": "",    "overlayText": "",    "durationSec": 8  },  "scenes": [    {      "id": 1,      "voiceText": "",      "visualSuggestion": "",      "overlayText": "",      "durationSec": 10    }  ],  "finalCTA": {    "voiceText": "",    "visualSuggestion": "",    "overlayText": "",    "durationSec": 8  },  "backgroundMusic": "soft gentle acoustic"}--- END`;  const response = await callAIModel(prompt, {    model: "gpt-4o-mini",    temperature: 0.6,    max_tokens: 3800,  });  const parsed = safeParseJSON(response);  if (!parsed || !parsed.scenes) {    throw new Error("AI JSON malformed or missing 'scenes'");  }  return parsed;}/** * üîÑ Converte JSON scene ‚Üí tabella usabile (CSV o Excel) */function flikiScenesToRows(scriptScenes) {  const rows = [];  const voiceName =    scriptScenes?.recommendedVoice?.name || "Michele";  const bgMusic = scriptScenes?.backgroundMusic || "soft gentle acoustic";  // Intro  if (scriptScenes.videoIntro) {    rows.push({      section: "intro",      scene_id: "",      voice: voiceName,      voiceText: scriptScenes.videoIntro.voiceText || "",      overlayText: scriptScenes.videoIntro.overlayText || "",      visualSuggestion: scriptScenes.videoIntro.visualSuggestion || "",      durationSec: scriptScenes.videoIntro.durationSec || "",      backgroundMusic: bgMusic,    });  }  // Scene principali  (scriptScenes.scenes || []).forEach((s) => {    rows.push({      section: "scene",      scene_id: s.id ?? "",      voice: voiceName,      voiceText: s.voiceText || "",      overlayText: s.overlayText || "",      visualSuggestion: s.visualSuggestion || "",      durationSec: s.durationSec || "",      backgroundMusic: bgMusic,    });  });  // CTA  if (scriptScenes.finalCTA) {    rows.push({      section: "finalCTA",      scene_id: "",      voice: voiceName,      voiceText: scriptScenes.finalCTA.voiceText || "",      overlayText: scriptScenes.finalCTA.overlayText || "",      visualSuggestion: scriptScenes.finalCTA.visualSuggestion || "",      durationSec: scriptScenes.finalCTA.durationSec || "",      backgroundMusic: bgMusic,    });  }  return rows;}/** * üìå 1Ô∏è‚É£ JSON puro ‚Äî /generate-smart/fliki */router.post("/fliki", async (req, res) => {  try {    const { topic, trendData, dnaData, targetAge = "over60" } = req.body;    if (!topic || !trendData || !dnaData) {      return res.status(400).json({        error: "Missing 'topic', 'trendData' or 'dnaData'",      });    }    const scriptScenes = await buildFlikiScenes({      topic,      trendData,      dnaData,      targetAge,    });    res.json({      status: "success",      engine: "SMART-FLIKI",      targetAge,      scriptScenes,    });  } catch (error) {    console.error("‚ùå /generate-smart/fliki Error:", error);    res.status(500).json({ error: "Errore generazione scene Fliki JSON" });  }});/** * üìå 2Ô∏è‚É£ CSV ‚Äî /generate-smart/fliki/csv */router.post("/fliki/csv", async (req, res) => {  try {    const { topic, trendData, dnaData, targetAge = "over60" } = req.body;    const scriptScenes = await buildFlikiScenes({      topic,      trendData,      dnaData,      targetAge,    });    const rows = flikiScenesToRows(scriptScenes);    const headers = Object.keys(rows[0] || {});    const csvLines = [];    csvLines.push(headers.join(";"));    rows.forEach((row) => {      const line = headers        .map((h) => `"${(row[h] || "").toString().replace(/"/g, '""')}"`)        .join(";");      csvLines.push(line);    });    res.setHeader("Content-Type", "text/csv");    res.setHeader(      "Content-Disposition",      'attachment; filename="fliki_scenes_smart.csv"'    );    res.send(csvLines.join("\n"));  } catch (error) {    console.error("‚ùå /generate-smart/fliki/csv Error:", error);    res.status(500).json({ error: "Errore generazione CSV" });  }});/** * üìå 3Ô∏è‚É£ EXCEL ‚Äî /generate-smart/fliki/xlsx */router.post("/fliki/xlsx", async (req, res) => {  try {    const { topic, trendData, dnaData, targetAge = "over60" } = req.body;    const scriptScenes = await buildFlikiScenes({      topic,      trendData,      dnaData,      targetAge,    });    const rows = flikiScenesToRows(scriptScenes);    const worksheet = XLSX.utils.json_to_sheet(rows);    const workbook = XLSX.utils.book_new();    XLSX.utils.book_append_sheet(workbook, worksheet, "FlikiScenes");    const xlsxBuffer = XLSX.write(workbook, {      type: "buffer",      bookType: "xlsx",    });    res.setHeader(      "Content-Disposition",      'attachment; filename="fliki_scenes_smart.xlsx"'    );    res.setHeader(      "Content-Type",      "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"    );    res.send(xlsxBuffer);  } catch (error) {    console.error("‚ùå /generate-smart/fliki/xlsx Error:", error);    res.status(500).json({ error: "Errore generazione Excel" });  }});export default router;