// =====================================================================//  ðŸ”¥ /analyzer-pro.js â€” VERSIONE TOP BEST ULTRA-PREMIUM//  Lâ€™intelligenza centrale della tua app. Livello oltre VidIQ + TubeBuddy.// =====================================================================import express from "express";import { callAIModel } from "../services/aiEngine.js";import {  getProfileByHandle,  getDefaultProfile,} from "../services/profileManager.js";const router = express.Router();// ---------------------------------------------------------//  UTIL â€” Estrazione JSON ultra-robusta// ---------------------------------------------------------function extractValidJson(text) {  try {    const first = text.indexOf("{");    const last = text.lastIndexOf("}");    if (first === -1 || last === -1) return null;    return text.substring(first, last + 1);  } catch {    return null;  }}// ---------------------------------------------------------//  UTIL â€” Fix automatico JSON// ---------------------------------------------------------function autoFixJsonString(str) {  return str    .replace(/,\s*}/g, "}")    .replace(/,\s*]/g, "]")    .replace(/[\u2018\u2019]/g, "'")    .replace(/[\u201C\u201D]/g, '"');}// ---------------------------------------------------------//  ðŸ”¥ Prompt Premium (Top Best) â€” Analisi completa// ---------------------------------------------------------function buildPrompt(transcript, profile) {  return `Sei "Zen YouTube Coach Pro â€” Analyzer Engine", la versione TOP BEST Ultra-Premium.Analizza questo transcript YouTube e genera una risposta SOLO e UNICAMENTE in JSON PRECISO.Transcript:${transcript}Target:- Pubblico Over50 / Over60 / Over70- Profilo richiesto: ${profile.label}Genera il seguente JSON:{  "video_title": "",  "estimatedDurationSec": 0,  "sections": [],  "retentionAnalysis": {    "dropMoments": [],    "weaknesses": [],    "suggestedFixes": []  },  "valueAnalysis": {    "clarity": "",    "engagement": "",    "psychologyPatterns": [],    "emotionalScore": ""  },  "topicStrength": "",  "audienceMatch": "",  "keyQuotes": [],  "viralPotential": "",  "seo": {    "bestTitle": "",    "hooks": [],    "tags": [],    "searchQueries": []  },  "videoStrategy": {    "thumbnailConcept": "",    "openingFix": "",    "ctaStrategy": "",    "contentGapToExploit": ""  }}REGOLE:- Nessun testo fuori dal JSON.- Nessuna spiegazione.- Nessun markdown.- No errori, no caratteri strani.- Se non sai una sezione, metti "" o [].`;}// ---------------------------------------------------------//  ðŸ§  Analize Pro â€” ENDPOINT ULTRA-PREMIUM// ---------------------------------------------------------router.post("/analyzer-pro", async (req, res) => {  try {    const { transcript, profileHandle } = req.body;    if (!transcript) {      return res.status(400).json({        success: false,        error: "Transcript mancante.",      });    }    // Profilo utente    const profile =      getProfileByHandle(profileHandle) || getDefaultProfile();    // Prompt    const prompt = buildPrompt(transcript, profile);    // -----------------------------------------------------    // ðŸ”¥ 1 â€” Chiamata AI con fallback automatico integrato    // -----------------------------------------------------    let aiResponse = await callAIModel(prompt);    // -----------------------------------------------------    // ðŸ”§ 2 â€” Estrazione JSON    // -----------------------------------------------------    let jsonRaw = extractValidJson(aiResponse);    if (!jsonRaw) {      jsonRaw = extractValidJson(autoFixJsonString(aiResponse));    }    if (!jsonRaw) {      return res.status(500).json({        success: false,        error: "Impossibile estrarre JSON dalla risposta AI.",        raw: aiResponse,      });    }    // -----------------------------------------------------    // ðŸ§¹ 3 â€” Fix finale del JSON    // -----------------------------------------------------    const fixedJson = autoFixJsonString(jsonRaw);    // -----------------------------------------------------    // ðŸ“¦ 4 â€” Parsing finale    // -----------------------------------------------------    let parsed;    try {      parsed = JSON.parse(fixedJson);    } catch (err) {      return res.status(500).json({        success: false,        error: "JSON non valido dopo il fix.",        original: aiResponse,        extracted: jsonRaw,        fixed: fixedJson,      });    }    // -----------------------------------------------------    // ðŸŽ‰ 5 â€” Risposta finale    // -----------------------------------------------------    return res.json({      success: true,      meta: {        profile: profile.label,      },      result: parsed,    });  } catch (err) {    console.error("ERRORE ANALYZER PRO:", err);    return res.status(500).json({      success: false,      error: "Errore interno AnalyzerPro",      details: err.message,    });  }});export default router;