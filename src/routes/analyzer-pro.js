// ======================================================// üöÄ /analyzer-pro ‚Äî Analyzer PRO// Analisi avanzata di un transcript per Over 50/60/70// ======================================================import express from "express";import { callAIModel } from "../services/aiEngine.js";const router = express.Router();/** * Body atteso: * * { *   "audience": "over60", *   "title": "Titolo video", *   "transcript": "testo...", *   "focus": "full" | "hook" | "structure" | "retention" * } */router.post("/", async (req, res) => {  try {    const {      audience = "over60",      title = "Video senza titolo",      transcript,      focus = "full"    } = req.body || {};    if (!transcript || typeof transcript !== "string" || transcript.trim().length < 50) {      return res.status(400).json({        success: false,        message:          "Serve un campo 'transcript' con almeno qualche riga di contenuto."      });    }    const focusLabel =      focus === "hook"        ? "concentrati soprattutto sull'hook e sui primi 30‚Äì60 secondi"        : focus === "structure"        ? "concentrati soprattutto sulla struttura narrativa"        : focus === "retention"        ? "concentrati soprattutto sulla retention e sui momenti morti"        : "fai un'analisi completa (hook, struttura, retention, CTA, Over 50)";    const prompt = `Sei "Zen YouTube Coach Pro", uno strategist YouTube avanzato.Analizzi script per pubblico ${audience} (Over 50, Over 60, Over 70).Titolo del video:"${title}"Transcript completo:${transcript}Il cliente ti chiede: ${focusLabel}.Devi agire come un "dottore" del contenuto e restituire:- overview: sintesi chiara dei problemi e punti di forza- hookFixes: cosa non funziona nell'apertura e come sistemarlo- structureFixes: come migliorare la struttura (hook ‚Üí storia ‚Üí rivelazione ‚Üí CTA)- retentionFixes: dove si perde attenzione e come alzare la retention- ctaFixes: come migliorare call-to-action finali e interne- over50Notes: note specifiche per il target Over 50/60/70- priorityActions: 3‚Äì7 azioni concrete da fare SUBITO‚ö†Ô∏è Rispondi SOLO con JSON, nessun testo fuori dal JSON, con questa struttura:{  "overview": "...",  "hookFixes": ["...", "..."],  "structureFixes": ["...", "..."],  "retentionFixes": ["...", "..."],  "ctaFixes": ["...", "..."],  "over50Notes": ["...", "..."],  "priorityActions": ["...", "..."]}`.trim();    // Prima passata: Groq    let raw = await callAIModel(prompt, "text", {      provider: "groq",      temperature: 0.25,      maxTokens: 6500    });    const tryParse = (txt) => {      try {        const first = txt.indexOf("{");        const last = txt.lastIndexOf("}");        if (first === -1 || last === -1) return null;        return JSON.parse(txt.substring(first, last + 1));      } catch {        return null;      }    };    let parsed = tryParse(raw);    // Fallback: GPT-4o-mini se JSON non valido    if (!parsed) {      console.warn("‚ö†Ô∏è /analyzer-pro: fallback a GPT-4o-mini");      raw = await callAIModel(prompt, "text", {        provider: "openai",        model: "gpt-4o-mini",        temperature: 0.1,        maxTokens: 7500      });      parsed = tryParse(raw);    }    if (!parsed) {      return res.status(500).json({        success: false,        message: "AI ha prodotto JSON non valido in /analyzer-pro.",        raw      });    }    return res.json({      success: true,      audience,      focus,      data: parsed    });  } catch (err) {    console.error("‚ùå /analyzer-pro ERROR:", err);    return res.status(500).json({      success: false,      message: "Errore interno /analyzer-pro: " + err.message    });  }});export default router;