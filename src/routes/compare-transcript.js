// =====================================================================//  ðŸ”¥ /compare-transcript.js â€” VERSIONE TOP BEST ULTRA-PREMIUM//  Confronto avanzato tra piÃ¹ transcript YouTube.//  App Zen YouTube Coach Pro â€” Livello superiore a VidIQ e TubeBuddy.// =====================================================================import express from "express";import { callAIModel } from "../services/aiEngine.js";import {  getProfileByHandle,  getDefaultProfile,} from "../services/profileManager.js";const router = express.Router();// ---------------------------------------------------------//  UTIL â€” Estrazione JSON robusta// ---------------------------------------------------------function extractValidJson(text) {  try {    const first = text.indexOf("{");    const last = text.lastIndexOf("}");    if (first === -1 || last === -1) return null;    return text.substring(first, last + 1);  } catch {    return null;  }}// ---------------------------------------------------------//  UTIL â€” Fix automatico JSON// ---------------------------------------------------------function autoFixJsonString(str) {  if (!str || typeof str !== "string") return str;  return str    .replace(/,\s*}/g, "}")    .replace(/,\s*]/g, "]")    .replace(/[\u2018\u2019]/g, "'")    .replace(/[\u201C\u201D]/g, '"');}// ---------------------------------------------------------//  ðŸ”¥ Prompt Premium â€” Confronto multiplo tra transcript// ---------------------------------------------------------function buildComparePrompt(videos, profile, primaryId) {  const serialized = videos    .map((v, i) => {      return `[VIDEO ${i + 1}]id: ${v.id}title: ${v.title}notes: ${v.notes}transcript:${v.transcript}`;    })    .join("\n\n");  return `Sei "Zen YouTube Coach Pro â€” Compare Engine", versione TOP BEST Ultra-Premium.Obiettivo: confrontare questi video per capire:- quale ha piÃ¹ potenziale per Over50 / Over60 / Over70,- quale struttura narrativa trattiene di piÃ¹,- quale ha hook piÃ¹ forte,- qual Ã¨ il miglior CTA,- come creare un MASTER VIDEO che sintetizzi il meglio di tutti,- come migliorare il video principale (primaryId: ${primaryId || "nessuno"}).Target richiesto: pubblico Over50 / Over60 / Over70Profilo: ${profile.label}Ecco i video da analizzare:${serialized}Genera SOLO questo JSON (nessun testo fuori dal JSON):{  "videoCount": 0,  "primaryId": "",  "globalInsights": {    "mainTheme": "",    "audienceFitOver50": "",    "audienceFitOver60": "",    "audienceFitOver70": "",    "psychologyPatterns": [],    "commonMistakes": [],    "missedOpportunities": []  },  "rankingByPotential": [    {      "id": "",      "title": "",      "reason": "",      "scoreOver50": 0,      "scoreOver60": 0,      "scoreOver70": 0,      "retentionPotential": "",      "viralPotential": ""    }  ],  "perVideoDetails": [    {      "id": "",      "title": "",      "hookStrength": "",      "hookSuggestions": [],      "structureStrengths": [],      "structureWeaknesses": [],      "clarity": "",      "emotionalDepth": "",      "ctaQuality": "",      "ctaSuggestions": [],      "seo": {        "suggestedTitle": "",        "suggestedHooks": [],        "tags": [],        "searchQueries": []      }    }  ],  "bestOfAllVideos": {    "bestHookIdea": "",    "bestOpening30SecondsBlueprint": "",    "bestCTA": "",    "bestTitleIdea": "",    "bestEmotionalAngle": "",    "notesForZenSaluteEBenessere": ""  },  "recommendedMasterVideoBlueprint": {    "targetAudience": "",    "estimatedDurationMinutes": 0,    "narrativeFlow": [      {        "step": 1,        "label": "",        "description": ""      }    ],    "openingHookExample": "",    "storyCore": "",    "valueDeliverySections": [],    "finalCTAExample": "",    "thumbnailConcept": ""  }}REGOLE FERREE:- Nessun testo fuori dal JSON.- Nessuna frase extra.- Se non sai qualcosa, usa "" oppure [] oppure 0.`;}// ---------------------------------------------------------//  ðŸ§  Endpoint principale Ultra-Premium// ---------------------------------------------------------router.post("/compare-transcript-pro", async (req, res) => {  try {    const { videos, primaryId, profileHandle } = req.body;    // Validazione    if (!videos || !Array.isArray(videos) || videos.length < 2) {      return res.status(400).json({        success: false,        error: "Servono almeno 2 video con transcript per il confronto.",      });    }    // Pulizia dei video    const cleanedVideos = videos      .filter(        (v) =>          v &&          typeof v.transcript === "string" &&          v.transcript.trim().length > 0      )      .map((v, index) => ({        id: v.id || `video_${index + 1}`,        title: v.title || "",        transcript: v.transcript,        notes: v.notes || "",      }));    if (cleanedVideos.length < 2) {      return res.status(400).json({        success: false,        error:          "Dopo la pulizia, meno di 2 transcript erano validi. Controlla i dati.",      });    }    // Profilo target    const profile =      getProfileByHandle(profileHandle) || getDefaultProfile();    // Prompt Premium    const prompt = buildComparePrompt(cleanedVideos, profile, primaryId);    // ðŸ”¥ Chiamata AI    const aiResponse = await callAIModel(prompt);    // Estrazione JSON    let jsonRaw = extractValidJson(aiResponse);    if (!jsonRaw) jsonRaw = extractValidJson(autoFixJsonString(aiResponse));    if (!jsonRaw) {      return res.status(500).json({        success: false,        error: "Impossibile estrarre JSON.",        raw: aiResponse,      });    }    // Fix    const fixedJson = autoFixJsonString(jsonRaw);    // Parsing    let parsed;    try {      parsed = JSON.parse(fixedJson);    } catch (err) {      return res.status(500).json({        success: false,        error: "JSON non valido dopo il fix.",        original: aiResponse,        extracted: jsonRaw,        fixed: fixedJson,      });    }    // Successo    return res.json({      success: true,      meta: {        profile: profile.label,        primaryId: primaryId || null,        videoCount: cleanedVideos.length,      },      result: parsed,    });  } catch (err) {    console.error("ERRORE COMPARE TRANSCRIPT PRO:", err);    return res.status(500).json({      success: false,      error: "Errore interno compare-transcript-pro",      details: err.message,    });  }});export default router;