// ============================================================// üé¨ generate.js ‚Äî Script Builder YouTube Over50/60/70 (7‚Äì9 minuti)// ============================================================import express from "express";import { callAI } from "../services/aiService.js";import { estimateSceneDurations } from "../utils/wordDuration.js";import { getDefaultProfile, getProfileByHandle } from "../services/profileManager.js"; //  üî• FIX DEFINITIVO: profileManager.js (no profile-Manager.js)const router = express.Router();// üéØ RUOLI CONSENTITIconst validRoles = [  "HOOK",  "PROBLEMA",  "SPIEGAZIONE",  "CAUSE",  "SOLUZIONI",  "STILE DI VITA",  "BENEFICI",  "MOTIVAZIONE",  "CTA"];/** * POST /generate/script * Genera uno script YouTube per pubblico Over 50 / Over 60 / Over 70 * Durata target: 7‚Äì9 minuti con voce Michele 145 wpm */router.post("/script", async (req, res) => {  try {    const { idea, handle } = req.body;    if (!idea) {      return res.status(400).json({ error: "Missing 'idea' field" });    }    // üß¨ Auto-profile    const profile = handle ? getProfileByHandle(handle) : getDefaultProfile();    const prompt = `Sei uno YouTube Script Builder professionale per il canale "${profile.channelName}".Pubblico: ${profile.targetAudience.join(", ")} (Over 50, Over 60, Over 70).Nicho: ${profile.niche}.Tono: ${profile.tone}.Genera SOLO JSON valido, nessun testo esterno.üéØ OBIETTIVO DURATA (modalit√† BASE):- Voce: Michele, 145 parole al minuto- Durata target: tra 7 e 9 minuti- Totale parole: idealmente tra 950 e 1200 paroleüé¨ STRUTTURA:- Dividi lo script in 16‚Äì22 scene- Ogni scena tra 50 e 75 parole- id: numero progressivo- role: HOOK, PROBLEMA, SPIEGAZIONE, CAUSE, SOLUZIONI, STILE DI VITA, BENEFICI, MOTIVAZIONE, CTA- text: linguaggio naturale, caldo, umanoüìå INTRO OBBLIGATORIA:- La PRIMA scena (HOOK) deve:  - aprire con immagine mentale o domanda forte  - parlare direttamente a chi ha pi√π di 50/60/70 anni  - citare il canale "${profile.channelName}"  - promettere un beneficio concretoüìå OUTRO OBBLIGATORIA:- L‚ÄôULTIMA scena (CTA) deve:  - invitare a ISCRIVERSI al canale "${profile.channelName}"  - ricordare che √® dedicato agli Over 50/60/70  - invitare a commentare e condividereüìå JSON FINALE:{  "video_title": "",  "scenes": [    { "id": 1, "role": "HOOK", "text": "..." }  ]}‚ö†Ô∏è REGOLE FERREE:- Nessun markdown- Nessun \\n- Nessuna frase tipo "Scena 1"- Tono umano, non medico.Argomento del video:"${idea}"Rispondi SOLO con JSON valido.`;    const aiRaw = await callAI(prompt, {      model: "gpt-4o-mini",      temperature: 0.7,      max_tokens: 4500    });    const aiResponse =      typeof aiRaw === "string" ? JSON.parse(aiRaw) : aiRaw;    if (!aiResponse || !aiResponse.scenes || !Array.isArray(aiResponse.scenes)) {      throw new Error("Invalid AI response format from /generate/script");    }    // üö¶ Normalizzazione ruoli + testo    aiResponse.scenes = aiResponse.scenes.map((scene, index) => {      const cleaned = { ...scene };      cleaned.id = typeof cleaned.id === "number" ? cleaned.id : index + 1;      cleaned.role = validRoles.includes(cleaned.role) ? cleaned.role : "CTA";      cleaned.text = typeof cleaned.text === "string" ? cleaned.text : String(cleaned.text || "");      return cleaned;    });    // ‚è±Ô∏è Stima durata    const {      scenesWithTime,      totalWords,      totalDurationSec,      totalDurationFormatted    } = estimateSceneDurations(aiResponse.scenes);    return res.json({      success: true,      result: {        video_title: aiResponse?.video_title || null,        profile,        voiceProfile: {          id: "michele",          label: "Michele (naturale, calmo)",          wpm: 145        },        totalWords,        estimatedDurationSec: totalDurationSec,        estimatedDurationFormatted: totalDurationFormatted,        sceneCount: scenesWithTime.length,        scenes: scenesWithTime      }    });  } catch (err) {    console.error("‚ùå /generate/script error:", err);    return res.status(500).json({ error: "Internal Server Error" });  }});export default router;