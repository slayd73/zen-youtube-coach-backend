// ============================================================// üìä generateRetentionScan.js ‚Äî Retention Predictor Engine// ============================================================import express from "express";import { callAI } from "../services/aiService.js";import {  getDefaultProfile,  getProfileByHandle,} from "../services/profileManager.js";   // ‚úÖ FIX DEFINITIVOconst router = express.Router();async function resolveProfile(profileHandle) {  try {    if (profileHandle) {      const p = await getProfileByHandle(profileHandle);      if (p) return p;    }  } catch (e) {    console.error("‚ö†Ô∏è profileHandle error (retention), fallback:", e);  }  try {    const def = await getDefaultProfile();    if (def) return def;  } catch (e) {    console.error("‚ö†Ô∏è getDefaultProfile error (retention):", e);  }  return {    handle: "zen-default-over50-70",    label: "Over 50/60/70 ‚Äì Salute e Benessere",    description:      "Pubblico Over 50, Over 60 e Over 70, interessato a sonno, salute semplice, alimentazione pratica e movimento dolce.",  };}/** * POST /generate/retentionScan * Analizza uno script (array di scene) e predice punti di drop + suggerimenti */router.post("/retentionScan", async (req, res) => {  try {    const { scenes, profileHandle } = req.body || {};    if (!Array.isArray(scenes) || scenes.length === 0) {      return res        .status(400)        .json({ error: "Provide non-empty 'scenes' array" });    }    const profile = await resolveProfile(profileHandle);    const profileDescription =      profile?.description || "Pubblico Over 50, Over 60 e Over 70.";    const scenesForAi = scenes.map((s) => ({      id: s.id,      role: s.role,      text: typeof s.text === "string" ? s.text : String(s.text || ""),    }));    const prompt = `Sei un "Retention Predictor" per YouTube, specializzato in pubblico Over 50/60/70,per il canale "Zen Salute e Benessere".Profilo attivo: ${profileDescription}SCRIPT (scene JSON):${JSON.stringify(scenesForAi)}üéØ COMPITO:Analizza lo script e restituisci SOLO JSON con:- globalScore: 0‚Äì100- strengths: []- weaknesses: []- riskZones: [{ sceneId, reason, suggestedFix }]- highImpactScenes: []- recommendations: []- hookRewriteSuggestion: ""Nessun testo fuori dal JSON.`;    const aiResponse = await callAI(prompt, {      model: "gpt-4o-mini",      temperature: 0.55,      max_tokens: 2500,    });    if (typeof aiResponse !== "object" || aiResponse === null) {      throw new Error("Invalid AI response format from retentionScan");    }    return res.json({      success: true,      result: aiResponse,    });  } catch (err) {    console.error("‚ùå /generate/retentionScan error:", err);    return res.status(500).json({ error: "Internal Server Error" });  }});export default router;