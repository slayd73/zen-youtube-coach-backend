// ======================================================// üìà /trend-scan ‚Äî Trend Scanner PRO v2// Analisi AI dei trend per nicchia + Over 50/60/70// ======================================================import express from "express";import { callAIModel } from "../services/aiEngine.js";const router = express.Router();/** * Body atteso: * { *   "niche": "sonno over 60", *   "audience": "over60", *   "language": "it", *   "mode": "explore" | "doubleDown" | "rescue" * } */router.post("/", async (req, res) => {  try {    const {      niche = "salute e benessere over 60",      audience = "over60",      language = "it",      mode = "explore"    } = req.body || {};    const modeLabel =      mode === "doubleDown"        ? "individua cosa sta gi√† funzionando e come spingerlo ancora di pi√π"        : mode === "rescue"        ? "aiuta un canale in difficolt√† a riprendersi"        : "scansiona la nicchia e intercetta i temi caldi emergenti";    const prompt = `Sei Zen YouTube Coach Pro, analista YouTube specializzato in pubblico ${audience} (Over 50/60/70)per la nicchia: "${niche}".Lingua preferita dei contenuti: ${language === "it" ? "Italiano" : "Inglese"}.Modalit√†: ${mode} ‚Üí il tuo compito √®: ${modeLabel}.Senza inventare dati falsi di analytics, ma ragionando sui trend reali e prevedibili della nicchia,genera un piano strategico YouTube.üî• RESTITUISCI SOLO UN JSON con questa struttura (nessun testo fuori dal JSON):{  "trendPrincipali": ["...", "..."],  "formatiCheFunzionano": ["...", "..."],  "ideeVideoLunghi": [    {      "titolo": "...",      "angolo": "...",      "percheFunzionaOver50": "...",      "hookSuggerito": "..."    }  ],  "ideeShorts": [    {      "titolo": "...",      "concept": "...",      "cta": "..."    }  ],  "hookPatterns": ["...", "..."],  "erroriDaEvitare": ["...", "..."],  "calendarSuggerito": {    "frequenza": "es. 3 video lunghi + 5 shorts a settimana",    "giorniConsigliati": ["Luned√¨", "Mercoled√¨", "Sabato"],    "note": "..."  },  "noteStrategiche": "..."}`.trim();    // Prima passata: Groq    let raw = await callAIModel(prompt, "text", {      provider: "groq",      temperature: 0.25,      maxTokens: 6500    });    const extractJSON = (txt) => {      try {        const first = txt.indexOf("{");        const last = txt.lastIndexOf("}");        if (first === -1 || last === -1) return null;        return JSON.parse(txt.substring(first, last + 1));      } catch {        return null;      }    };    let parsed = extractJSON(raw);    if (!parsed) {      console.warn("‚ö†Ô∏è /trend-scan: fallback a GPT-4o-mini");      raw = await callAIModel(prompt, "text", {        provider: "openai",        model: "gpt-4o-mini",        temperature: 0.15,        maxTokens: 7500      });      parsed = extractJSON(raw);    }    if (!parsed) {      return res.status(500).json({        success: false,        message: "AI ha prodotto JSON non valido in /trend-scan.",        raw      });    }    return res.json({      success: true,      niche,      audience,      mode,      data: parsed    });  } catch (err) {    console.error("‚ùå /trend-scan ERROR:", err);    return res.status(500).json({      success: false,      message: "Errore interno /trend-scan: " + err.message    });  }});export default router;