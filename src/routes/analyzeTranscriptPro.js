// ============================================================// üîç /analyze/transcriptPro ‚Äî Premium Narrative & Retention Analyzer// ============================================================import express from "express";import { callAI } from "../services/aiService.js";import {  getProfileByHandle,  getDefaultProfile,} from "../services/profileManager.js";   // ‚úîÔ∏è NOME CORRETTOconst router = express.Router();/** * üîß Estrae il primo oggetto JSON valido da una stringa */function extractJsonObject(text) {  if (typeof text !== "string") return null;  const first = text.indexOf("{");  const last = text.lastIndexOf("}");  if (first === -1 || last === -1 || last <= first) return null;  return text.substring(first, last + 1);}/** * üîß Safe JSON parse con fallback */function safeParseJSON(raw) {  try {    if (typeof raw === "object") return raw;    const sliced = extractJsonObject(raw);    if (!sliced) return null;    return JSON.parse(sliced);  } catch (err) {    console.error("‚ùå JSON PARSE ERROR (transcriptPro):", err);    return null;  }}router.post("/transcriptPro", async (req, res) => {  try {    const {      transcript,      title = null,      url = null,      profileHandle = null,      options = {},    } = req.body || {};    if (!transcript || typeof transcript !== "string" || transcript.trim().length < 100) {      return res.status(400).json({        error: "Missing or too short 'transcript'. Minimo 100 caratteri di testo reale.",      });    }    // üß¨ Auto-Profile    const activeProfile =      (profileHandle && getProfileByHandle(profileHandle)) ||      getDefaultProfile();    const {      handle = "zen-over-50-60-70",      audienceLabel = "Over 50 / Over 60 / Over 70",      language = "it",      tone = "caldo, empatico, incoraggiante, semplice",    } = activeProfile || {};    const boostQuestions =      typeof options.boostQuestions === "boolean" ? options.boostQuestions : true;    const hookSurgeon =      typeof options.hookSurgeon === "boolean" ? options.hookSurgeon : true;    // üß† PROMPT PREMIUM    const prompt = `Sei "Zen YouTube Coach Pro ‚Äì Analyze Mode", un analista narrativo di altissimo livello,specializzato in video di salute, sonno, benessere e alimentazione per pubblico${audienceLabel}, lingua ${language}, tono ${tone}.Il canale di riferimento √® sempre "Zen Salute e Benessere".Ogni suggerimento deve essere coerente con questo brand.Devi analizzare lo SCRIPT / TRANSCRIPT qui sotto e restituire SOLO JSON valido.===== TRANSCRIPT INIZIO =====Titolo (se fornito): ${title || "N/D"}URL (se fornita): ${url || "N/D"}${transcript}===== TRANSCRIPT FINE =====`;    // üîÆ AI CALL    const rawAI = await callAI(prompt, {      model: "gpt-4o-mini",      temperature: 0.35,      max_tokens: 4800,    });    const parsed = safeParseJSON(rawAI);    if (!parsed || typeof parsed !== "object") {      console.error("‚ùå /analyze/transcriptPro ‚Äî AI response non valido:", rawAI);      return res.status(500).json({        error: "AI response not in expected JSON format (transcriptPro).",        raw: typeof rawAI === "string" ? rawAI.slice(0, 500) : rawAI,      });    }    // üîß Metadati aggiuntivi    if (!parsed.meta) parsed.meta = {};    parsed.meta.title = parsed.meta.title || title || "Analisi video";    parsed.meta.sourceUrl = parsed.meta.sourceUrl || url || null;    parsed.meta.profileHandleUsed = parsed.meta.profileHandleUsed || handle;    parsed.meta.audience = parsed.meta.audience || audienceLabel;    parsed.meta.language = parsed.meta.language || language;    return res.json({      success: true,      result: parsed,    });  } catch (err) {    console.error("‚ùå /analyze/transcriptPro error:", err);    return res.status(500).json({      error: "Internal Server Error on /analyze/transcriptPro",    });  }});export default router;