// ======================================================// üìâ /dropoff-explain ‚Äî Spiegazione punti di abbandono// ======================================================import express from "express";import { callAIModel } from "../services/aiEngine.js";const router = express.Router();/** * Body: * { *   "transcript": "testo completo", *   "dropPoints": ["0:30", "1:45", ...], *   "audience": "over60", *   "forceProvider": "auto" * } */router.post("/", async (req, res) => {  try {    const {      transcript,      dropPoints = [],      audience = "over60",      forceProvider = "auto"    } = req.body || {};    if (!transcript) {      return res.status(400).json({        ok: false,        error: "Missing 'transcript'"      });    }    if (!Array.isArray(dropPoints) || dropPoints.length === 0) {      return res.status(400).json({        ok: false,        error: "dropPoints must be a non-empty array of timestamps"      });    }    const prompt = `Ti fornisco il transcript di un video e una lista di timestamp in cui la retention crolla.Spiega perch√© le persone abbandonano e come riscrivere quei punti.Target: ${audience}Transcript:${transcript}Drop points:${dropPoints.join(", ")}Rispondi SOLO con JSON:{  "analisiDropoff": [    {      "timestamp": "0:30",      "motivoProbabile": "...",      "tipoProblema": "noia|confusione|tecnico|ripetizione",      "riscritturaSuggerita": "testo alternativo pi√π forte"    }  ],  "lineeGuidaGenerali": ["..."]}`.trim();    const aiResp = await callAIModel(prompt, "json", {      task: "dropoff-explain",      temperature: 0.25,      maxTokens: 4500,      forceProvider    });    if (aiResp?.error) {      return res.status(502).json({        ok: false,        error: "AI dropoff explanation failed",        details: aiResp      });    }    return res.json({      ok: true,      providerUsed: forceProvider,      data: aiResp    });  } catch (err) {    console.error("‚ùå /dropoff-explain ERROR:", err);    res.status(500).json({      ok: false,      error: "dropoff-explain route crashed",      details: err.message    });  }});export default router;