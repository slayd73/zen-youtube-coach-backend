// ======================================================// üìä /analyze-video ‚Äî Analyze Video PRO Ultra 2025// ======================================================import express from "express";import { getTranscript } from "../services/transcriptService.js";import { getYouTubeTitle } from "../services/youtubeTitleService.js";import { callAIModel } from "../services/aiEngine.js";const router = express.Router();/** * Body: * { "url": "...", "audience": "over60" } */router.post("/", async (req, res) => {  try {    const { url, audience = "over60" } = req.body || {};    if (!url)      return res.status(400).json({        success: false,        message: "Serve un campo 'url'"      });    // 1Ô∏è‚É£ Transcript    const transcriptData = await getTranscript(url);    if (!transcriptData || transcriptData.error) {      return res.status(400).json({        success: false,        message: "Impossibile ottenere transcript"      });    }    const text = transcriptData.aiText || transcriptData.continuousText;    if (!text || text.length < 80) {      return res.status(400).json({        success: false,        message: "Transcript insufficiente o vuoto"      });    }    // 2Ô∏è‚É£ Titolo da YouTube    const realTitle = await getYouTubeTitle(url);    // 3Ô∏è‚É£ Prompt per AI    const prompt = `Sei "Zen YouTube Coach Pro". Analizza un video per pubblico ${audience}(Over 50 / Over 60 / Over 70).Titolo effettivo del video:"${realTitle || "Nessun titolo recuperato"}"Transcript del video:${text}Devi generare il seguente output:{  "ideaScore": 0-10,  "hookScore": 0-10,  "retentionScore": 0-10,  "structureScore": 0-10,  "titleScore": 0-10,  "summary": "riassunto strategico",  "strengths": ["...", "..."],  "weaknesses": ["...", "..."],  "titleImprovements": ["...", "..."],  "alternateTitles": ["titolo 1", "titolo 2", ... 10 varianti],  "seoNotes": "consigli SEO su titolo/descrizione/tag",  "quickFixes": ["...", "..."]}‚ö†Ô∏è Rispondi SOLO con JSON valido.`.trim();    let raw = await callAIModel(prompt, "text", {      provider: "groq",      temperature: 0.25,      maxTokens: 5500    });    // JSON extractor    const first = raw.indexOf("{");    const last = raw.lastIndexOf("}");    let parsed = null;    if (first !== -1 && last !== -1) {      try {        parsed = JSON.parse(raw.substring(first, last + 1));      } catch {        parsed = null;      }    }    if (!parsed) {      return res.status(500).json({        success: false,        message: "JSON non valido",        raw      });    }    return res.json({      success: true,      url,      title: realTitle || "Titolo non recuperato",      audience,      data: parsed    });  } catch (err) {    console.error("‚ùå analyze-video error:", err);    return res.status(500).json({      success: false,      message: err.message    });  }});export default router;