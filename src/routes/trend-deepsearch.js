// =====================================================================//  ðŸ”¥ /trend-deepsearch.js â€” VERSIONE TOP BEST ULTRA-PREMIUM//  Trend Scanner AI Over50/60/70//  Livello oltre VidIQ, Glasp, TubeBuddy.// =====================================================================import express from "express";import { callAIModel } from "../services/aiEngine.js";import {  getProfileByHandle,  getDefaultProfile,} from "../services/profileManager.js";const router = express.Router();// ---------------------------------------------------------//  UTIL â€” Estrazione JSON robusta// ---------------------------------------------------------function extractValidJson(text) {  try {    const first = text.indexOf("{");    const last = text.lastIndexOf("}");    if (first === -1 || last === -1) return null;    return text.substring(first, last + 1);  } catch {    return null;  }}// ---------------------------------------------------------//  UTIL â€” Fix JSON// ---------------------------------------------------------function autoFixJsonString(str) {  if (!str || typeof str !== "string") return str;  return str    .replace(/,\s*}/g, "}")    .replace(/,\s*]/g, "]")    .replace(/[\u2018\u2019]/g, "'")    .replace(/[\u201C\u201D]/g, '"');}// ---------------------------------------------------------//  ðŸ”¥ Prompt Premium â€” Trend Deep Search// ---------------------------------------------------------function buildTrendPrompt(query, profile) {  return `Sei "Zen YouTube Coach Pro â€” TrendDeepSearch Engine", versione TOP BEST Ultra-Premium.Analizza il TREND attorno al seguente tema:"${query}"Target: Over50 / Over60 / Over70Profilo: ${profile.label}OBIETTIVI:- Scoprire le migliori opportunitÃ  di contenuti YouTube attuali.- Analizzare trend globali, microtrend, long-tail, topic emergenti.- Identificare i formati piÃ¹ performanti.- Capire cosa funziona nel pubblico Over50/60/70.- Creare idee originali, uniche e non saturate.- Fornire hooks e thumbnail concept psicologicamente ottimali.- Detectare i GAP rispetto ai competitor.Rispondi SOLO in JSON con questa struttura:{  "topic": "",  "query": "",  "interestLevelOver50": "",  "interestLevelOver60": "",  "interestLevelOver70": "",  "trendCategory": "",  "globalInsights": {    "whyNow": "",    "problemAudienceFeels": "",    "emotionalDrivers": [],    "informationGaps": []  },  "opportunityRanking": [    {      "title": "",      "reason": "",      "competitionLevel": "",      "audienceDesireScore": 0,      "uniquenessScore": 0,      "formatRecommended": "",      "idealDurationMinutes": 0    }  ],  "longTailGems": [    {      "keyword": "",      "whyWorks": "",      "audienceIntent": ""    }  ],  "videoIdeas": [    {      "title": "",      "hook": "",      "thumbnailConcept": "",      "angle": "",      "whyThisWorksOver50_60_70": ""    }  ],  "competitorGapAnalysis": {    "whatOthersMiss": [],    "differentiationPoints": [],    "contentAnglesToOwn": []  },  "scriptBlueprint": {    "openingHook": "",    "introAngle": "",    "mainSections": [],    "storytellingElement": "",    "finalCTA": ""  },  "tags": [],  "searchQueries": []}REGOLE:- Nessun testo fuori dal JSON.- Nessuna frase extra.- Se non sai una sezione, usa "" o [] o 0.`;}// ---------------------------------------------------------//  ðŸ§  Endpoint: Trend DeepSearch Pro// ---------------------------------------------------------router.post("/trend-deepsearch-pro", async (req, res) => {  try {    const { query, profileHandle } = req.body;    if (!query || typeof query !== "string") {      return res.status(400).json({        success: false,        error: "Parametro 'query' mancante o non valido.",      });    }    // Profilo    const profile =      getProfileByHandle(profileHandle) || getDefaultProfile();    // Prompt    const prompt = buildTrendPrompt(query, profile);    // ðŸ”¥ AI Request    const aiResponse = await callAIModel(prompt);    // Estrazione JSON    let jsonRaw = extractValidJson(aiResponse);    if (!jsonRaw) jsonRaw = extractValidJson(autoFixJsonString(aiResponse));    if (!jsonRaw) {      return res.status(500).json({        success: false,        error: "Impossibile estrarre JSON dalla risposta AI.",        raw: aiResponse,      });    }    // Fix finale    const fixedJson = autoFixJsonString(jsonRaw);    // Parsing    let parsed;    try {      parsed = JSON.parse(fixedJson);    } catch (err) {      return res.status(500).json({        success: false,        error: "JSON non valido dopo fix.",        original: aiResponse,        extracted: jsonRaw,        fixed: fixedJson,      });    }    // Risposta finale    return res.json({      success: true,      meta: {        profile: profile.label,        query,      },      result: parsed,    });  } catch (err) {    console.error("ERRORE TREND DEEPSEARCH:", err);    return res.status(500).json({      success: false,      error: "Errore interno TrendDeepSearch",      details: err.message,    });  }});export default router;