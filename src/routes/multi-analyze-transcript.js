// ======================================================// üöÄ /multi-analyze-transcript ‚Äî Versione PRO// Analisi multipla (3-5 transcript) con ranking// ======================================================import express from "express";import { callAIModel } from "../services/aiEngine.js";import { getProfileByHandle, getDefaultProfile } from "../services/profileManager.js";const router = express.Router();router.post("/", async (req, res) => {  try {    const { transcripts, handle } = req.body;    // ‚ùó Serve un array con almeno 3 transcript    if (!Array.isArray(transcripts) || transcripts.length < 3) {      return res.status(400).json({        error: true,        message: "Servono almeno 3 transcript in un array chiamato 'transcripts'"      });    }    if (transcripts.length > 5) {      return res.status(400).json({        error: true,        message: "Massimo 5 transcript per analisi multipla"      });    }    // üéØ Profilo canale    const channelProfile = handle      ? getProfileByHandle(handle)      : getDefaultProfile();    if (!channelProfile) {      return res.status(500).json({        error: true,        message: "Profilo canale non trovato"      });    }    // üß† Prompt AI ‚Äî JSON strutturato e PULITO    const aiPrompt = `Confronta i seguenti transcript video YouTube (pubblico over 50/60/70):${JSON.stringify(transcripts, null, 2)}Profilo canale:${JSON.stringify(channelProfile, null, 2)}Analizza SOLO questi criteri:1Ô∏è‚É£ Hook iniziale (impatto, chiarezza, empatia)2Ô∏è‚É£ Retention (capacit√† di mantenere attenzione)3Ô∏è‚É£ Linguaggio e chiarezza (semplicit√†, comprensibilit√†)4Ô∏è‚É£ Coinvolgimento emotivo (storie, paure, motivazione)5Ô∏è‚É£ Adattabilit√† a Over50/60/706Ô∏è‚É£ CTA finale ‚Äî efficacia per pubblico over‚ö†Ô∏è OUTPUT OBBLIGATORIO (JSON puro, niente Markdown, niente testi extra):{  "ranking": [    { "position": 1, "videoIndex": 0, "reason": "" },    { "position": 2, "videoIndex": 2, "reason": "" }  ],  "hook_scores": {    "0": "",    "1": "",    "2": ""  },  "retention_scores": {    "0": "",    "1": "",    "2": ""  },  "over70_fit_scores": {    "0": "",    "1": "",    "2": ""  },  "strength_matrix": [    {      "videoIndex": 0,      "hook_strength": "",      "emotional_trigger": "",      "cta_effectiveness": "",      "main_weakness": ""    }  ],  "best_video": ""}‚ö†Ô∏è Nessun commento, nessuna spiegazione fuori dal JSON.`;    // üß† Chiamata AI    const raw = await callAIModel(aiPrompt, "text");    // üßπ Pulisci & converte JSON    const start = raw.indexOf("{");    const end = raw.lastIndexOf("}");    const cleanedJSON = JSON.parse(raw.slice(start, end + 1));    return res.status(200).json({      channelProfile,      comparison: cleanedJSON    });  } catch (error) {    console.error("‚ùå /multi-analyze-transcript ERROR:", error);    res.status(500).json({ error: "Errore interno server" });  }});export default router;